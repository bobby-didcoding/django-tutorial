# Django course
This is my Django course. I hope you like it.

> These notes follow on from steps/admin.md
***
***

## Prepare your local project
You will need to clone down a new module to follow along.
```
git checkout user_app
git pull origin user_app
```


## Steps/Commands
>Note: Please 'cd' into the root directory and fire up your virtual environment!

1) Django extensions - In todays module, we will be using a great library called Django extensions. This gives us access to some handy abstract models and functionality that I use daily. Let's go ahead and install the library and add it to our requirements.txt file.
```
pip install django-extensions
pip freeze > requirements.txt
```

1) Create a Users app - Open a terminal and use the following command to create a new app.
```
django-admin startapp users
```

2) Register application - Open django_course/settings.py and register the new application in INSTALLED_APPS.

```
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'core',
    'users', # This is our new app
    'django_extensions', # This is the new extensions library
]   
```

3) Write a model - Open django_course/users/models.py and write our first model. A Django model will become a database table when we migrate to SQL.

```
from django.conf import settings
from django.contrib.auth.models import User
from django.db import models

#these are model abstracts from django extensions
from django_extensions.db.models import (
    TimeStampedModel,
	ActivatorModel 
)

class UserProfile(TimeStampedModel,ActivatorModel,models.Model):
    '''
    Our UserProfile model extends the built-in Django User Model
    This is specific to the user! i.e. the individual that signs up
    '''
    class Meta:
        verbose_name_plural = 'User profiles'
        ordering = ["id"]

    user = models.OneToOneField(User, on_delete=models.CASCADE)
    telephone = models.CharField(verbose_name="Contact telephone number", max_length=255, null=True, blank=True)
    address = models.CharField(verbose_name="Address",max_length=100, null=True, blank=True)
    town = models.CharField(verbose_name="Town/City",max_length=100, null=True, blank=True)
    county = models.CharField(verbose_name="County",max_length=100, null=True, blank=True)
    post_code = models.CharField(verbose_name="Zip/Post Code",max_length=8, null=True, blank=True)
    country = models.CharField(verbose_name="Country",max_length=100, null=True, blank=True)
    longitude = models.CharField(verbose_name="Longitude",max_length=50, null=True, blank=True)
    latitude = models.CharField(verbose_name="Latitude",max_length=50, null=True, blank=True)
	
    def __str__(self):
        if self.user.first_name and self.user.last_name:
            return f'{self.user.first_name} {self.user.last_name}'
        return self.user.email
```

4) Make migrations - Django has some handy commands that quickly and easily create migration files. Use the following command to create our first migration files.

```
python manage.py makemigrations
```
You will see something similar to this in your log
```
Migrations for 'users':
  users\migrations\0001_initial.py
    - Create model UserProfile
```

Now open users\migrations\0001_initial.py. You will see the following code.
```
# Generated by Django 4.0.6 on 2022-08-04 14:19

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django_extensions.db.fields


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='UserProfile',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created', django_extensions.db.fields.CreationDateTimeField(auto_now_add=True, verbose_name='created')),
                ('modified', django_extensions.db.fields.ModificationDateTimeField(auto_now=True, verbose_name='modified')),
                ('status', models.IntegerField(choices=[(0, 'Inactive'), (1, 'Active')], default=1, verbose_name='status')),
                ('activate_date', models.DateTimeField(blank=True, help_text='keep empty for an immediate activation', null=True)),
                ('deactivate_date', models.DateTimeField(blank=True, help_text='keep empty for indefinite activation', null=True)),
                ('telephone', models.CharField(blank=True, max_length=255, null=True, verbose_name='Contact telephone number')),
                ('address', models.CharField(blank=True, max_length=100, null=True, verbose_name='Address')),
                ('town', models.CharField(blank=True, max_length=100, null=True, verbose_name='Town/City')),
                ('county', models.CharField(blank=True, max_length=100, null=True, verbose_name='County')),
                ('post_code', models.CharField(blank=True, max_length=8, null=True, verbose_name='Zip/Post Code')),
                ('country', models.CharField(blank=True, max_length=100, null=True, verbose_name='Country')),
                ('longitude', models.CharField(blank=True, max_length=50, null=True, verbose_name='Longitude')),
                ('latitude', models.CharField(blank=True, max_length=50, null=True, verbose_name='Latitude')),
                ('user', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name_plural': 'User profiles',
                'ordering': ['id'],
            },
        ),
    ]

```
This code is used to create the necessary SQL tables in our database.

5) Migrate to database - We have already used the following command in a pervious module. The migrate command cycles through the migration files and create/updates the SQL tables as necessary.
```
python manage.py migrate
```

You should see this in your terminal log
```
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, users
Running migrations:
  Applying users.0001_initial... OK
```

6) Register to Admin - You can now register our UserProfile model to admin. This will allow us to manage UserProfile entries in the built-in admin page. open /users/admin.py and pase the following code into your editor.

```
from django.contrib import admin
from .models import UserProfile

@admin.register(UserProfile)
class UserProfileAdmin(admin.ModelAdmin):
    list_display = ('id', 'user')
```

You will now be able to manage UserProfile entries here [http://127.0.0.1:8000/admin/users/userprofile/](http://127.0.0.1:8000/admin/users/userprofile/).

>Note: You will notice that the superuser account that was created in the last module does not have a UserProfile. We will fix this.

5) Signals - Let's go ahead and write some code that will create a UserProfile for every user that signs up (including superusers). Create a new file in /users called signals.py and paste in the following code.

```
from django.db.models.signals import post_save
from django.contrib.auth.models import User
from django.dispatch import receiver
from . models import UserProfile

@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
    if created:
        obj = UserProfile.objects.get_or_create(user=instance)

```

The signal needs to be registered so that it is run every time a user signs up. Open /users/apps.py and past in the following code.

```
from django.apps import AppConfig

class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'

    def ready(self):
        import users.signals
```

To test this functionality, sign into the built-in admin page and create a new user. Make sure you give this user 'staff' and 'superuser' privileges as this will become our new account.

If all went well, there should be a new UserProfile entry here [http://127.0.0.1:8000/admin/users/userprofile/](http://127.0.0.1:8000/admin/users/userprofile/).

To bookend signals, go ahead and delete our original user profile.
>Note: you will be asked to sign in again with the new details.


***
***

## Root directory
>Note: If all went well, your root directory should now look like this
```
django_course\  <--This is the root directory
    core\
        __pycache__\
        migrations\
            __pycache__\
            >__init__.py
        >__init__.py
        >admin.py
        >apps.py
        >models.py
        >tests.py
        templates\
            core\
                >index.html
        >urls.py
        >views.py
    django_course\
        __pycache__\
        >__init__.py
        >asgi.py
        >settings.py
        >urls.py
        >wsgi.py
    media\ <--New directory
    static\ <--New directory
    staticfiles\ <--New directory
    steps\
        >admin.md
        >basics.md
        >basics_part_2.md
        >debug.md
        >user_app.md
    users\
        __pycache__\
        migrations\
            __pycache__\
            >__init__.py
            >0001_initial.py
        >__init__.py
        >admin.py
        >apps.py
        >models.py
        >signals.py
        >tests.py
        >views.py
    venv\
        include\
        Lib\
        Scripts\
    >.gitignore
    >db.sqlite3
    >manage.py
    >README.md
    >requirements.txt
```

***
***